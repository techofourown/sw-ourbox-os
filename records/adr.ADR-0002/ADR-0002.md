---
typeId: adr
recordId: ADR-0002
parent: doc_area:decisions
fields:
  title: "ADR-0002: Adopt CouchDB + PouchDB and Standardize OurBox Data Modeling (Tenant DBs + Partitions)"
  adrCode: "ADR-0002"
  status: "Accepted (Updated)"
  date: "2026-01-25"
  legacyPath: "docs/decisions/ADR-0002-adopt-couchdb-and-pouchdb-for-offline-first-sync.md"
---
# ADR-0002: Adopt CouchDB + PouchDB and Standardize OurBox Data Modeling (Tenant DBs + Partitions)

## Status
Accepted (Updated)

## Date
2026-01-25

## Deciders
Founder (initial); future Board + Members (ratification/amendment per `docs/policies/founding/CONSTITUTION.md`)

## Context

ADR-0001 commits OurBox OS to shipped apps that are offline-first PWAs that withstand sporadic sync
with resilient sync.

If we choose a traditional relational database (e.g., Postgres) as the primary store, we would need
to design, build, and maintain a long-lived platform surface area:

- client ↔ server sync protocols
- incremental change feeds
- resumable replication
- conflict representation and resolution

CouchDB and PouchDB provide a mature, widely-used local-first replication model:

- **PouchDB** runs in the browser (IndexedDB-backed) as the local working store
- **CouchDB** runs on the box as the sync target and system-of-record
- replication is incremental and built-in

We also need a data modeling posture that is:

- robust under offline writes
- explicit about conflict boundaries
- consistent across apps
- “CouchDB-ish” (document-oriented, revision-based, replication-first)

This decision does **not** change the Operator Truth posture:
the device operator can access anything on the box if they choose to do so.
Our goal is coherent offline-first product architecture, not hostile-admin confidentiality.

We explicitly do **not** want to carry two primary database stacks long-term. If sync is core,
the primary store must be sync-native.

## Decision

We will adopt **CouchDB (on the box)** and **PouchDB (in the browser)** as the primary data store
stack for OurBox OS shipped apps.

We will standardize on:

- **One CouchDB database per tenant** (“tenant DB”)
- Each tenant DB is a **partitioned database** (CouchDB partitions feature)
- The CouchDB **partition key is the document kind** (`doc_kind`)
- `doc_kind` is derived from `_id` **only** (no separate `doc_type` field)
- Shipped apps store data as **one document per entity** (task, note, contact, event, etc.)
- On each client device, within a given **tenant origin**, shipped apps share **one local PouchDB database**
  (“local tenant replica”) so multiple apps can operate on the same doc kinds offline

Document ID generation and `_id` grammar details are finalized in ADR-0004.

## Normative design rules

### 1) Tenant databases (DB-per-tenant)
1. Each tenant has exactly one primary CouchDB database on the box: the **tenant DB**.
2. Tenant DB naming pattern (recommended):
   - `tenant_<tenant_id>`
   - examples: `tenant_bob`, `tenant_alice`, `tenant_family`
3. Shipped apps replicate against the tenant DB for the currently selected tenant origin.

**Non-goal:** selective replication by partition. Replication is tenant DB ↔ tenant DB.

### 2) Tenant DBs are partitioned databases
1. All tenant DBs MUST be created as **partitioned databases**.
2. All application documents MUST use partitioned `_id` format:
   - `_id = "<doc_kind>:<doc_uuid>"`
3. The **partition key** is `doc_kind` (see Rule 3).

### 3) Document kinds (partition keys) are canonical
1. `doc_kind` is the canonical classification for documents.
2. `doc_kind` MUST be derived only from `_id` (prefix before the first `:`).
3. Apps and services MUST NOT store a second source of truth for doc kind (e.g., no `doc_type` field).

Normative initial doc kinds (stable vocabulary for shipped apps):
- `note`, `task`, `contact`, `event`, `meta`

Reserved CouchDB system `_id` prefixes:
- `_design/…` (design documents)
- `_local/…` (local documents; not replicated)

Normative rule:
- Shipped apps MUST NOT create application documents with `_id` prefixes that collide with reserved CouchDB system prefixes.

### 4) One document per entity (conflict boundaries)
1. Shipped apps MUST model user-editable entities as individual documents.
   - Each note is a document.
   - Each task is a document.
   - Each contact is a document.
   - Each calendar event is a document.
2. “Giant documents” that aggregate many independent entities (e.g., “all tasks in one doc”) are forbidden for shipped apps,
   except for explicitly designated `meta` documents as described in ADR-0004.

Rationale: document boundary = conflict boundary. Offline writes require minimizing conflicts.

### 5) `_id` stability and migrations
1. `_id` MUST be stable for the lifetime of a document.
2. Renaming doc kinds (e.g., `note` → `notes`) is a deliberate migration and is acceptable, but MUST be treated as a migration (new IDs).
3. Moving a document between doc kinds is a migration (new IDs) and is acceptable, but MUST be explicit.
4. Document ID generation is defined by ADR-0004:
   - `doc_uuid` MUST be UUIDv4
   - ULIDs are prohibited for OurBox document `_id`s

### 6) Query posture (open-source only; Mango allowed)
1. OurBox uses open source CouchDB features. The **Mango query language** is permitted.
2. Shipped apps MUST use one of:
   - partition-appropriate access patterns (e.g., partition-aware endpoints and/or `_id` prefix/range patterns), and/or
   - CouchDB views/design docs, and/or
   - Mango queries (where appropriate)
3. Shipped apps MUST NOT rely on unindexed full scans of the entire tenant DB as a steady-state behavior.

(Exact index strategy is app-specific; this ADR sets the posture, not the exact indexes.)

### 7) Local tenant replicas are per device + tenant origin and shared across apps
**Purpose:** enable offline-first writes and allow multiple apps to operate on the same doc kinds (e.g., SimpleNote + RichNote
both operate on `note:*`) without creating multiple local sources of truth on a single device.

Definitions (normative for this ADR):
- A **web origin** is the browser security boundary `(scheme, host, port)`.
- A **tenant origin** is the origin whose host encodes the tenant:
  - `https://<tenant_id>.<box-host>/...`
- A **local tenant replica** is a PouchDB database stored in the browser (IndexedDB-backed) within a tenant origin on a specific client device.

Rules:
1. On each client device, within a given tenant origin, there MUST be exactly one PouchDB database that acts as the tenant’s
   local working store on that device: the **local tenant replica**.
2. All shipped apps served under the same tenant origin MUST read/write through the same local tenant replica on that device.
3. Scope clarification:
   - “exactly one” is per **(device + browser + tenant origin)**.
   - Therefore, the same tenant will naturally have multiple local tenant replicas across multiple devices
     (e.g., Bob’s phone and Bob’s laptop each have their own local tenant replica for `https://bob.<box-host>`).
4. The local tenant replica MUST replicate opportunistically with the tenant DB on the box (Rule 8).
5. Because apps share a tenant origin and a single local tenant replica, app boundaries are not a hard isolation boundary in the browser; preventing cross-doc-kind writes is enforced by discipline and tests (ADR-0001).

Local naming (recommended):
- local PouchDB name: `tenant_local` (within the browser origin)
  - The origin provides tenant separation; the local database name does not need to embed `tenant_id`.

Rationale:
- If each app maintained its own local PouchDB database, apps would not see each other’s changes offline and would create
  multiple local sources of truth for the same doc kinds.

### 8) Replication posture
1. Replication is incremental and resumable (CouchDB/PouchDB replication protocol).
2. Replication is treated as availability/redundancy, not “backup.”
   - Replication can copy bad changes and deletions.
3. Default replication unit is the tenant DB:
   - local tenant replica ↔ `tenant_<tenant_id>` (CouchDB)
4. Backup/retention (snapshots/versioned archives) is a separate system concern.

### 9) Large blobs are not stored as CouchDB attachments by default
1. Photos/video/audio and other large blobs are stored as files (content-addressed where feasible).
2. CouchDB documents store metadata and references/hashes to blobs.

## Rationale

- Offline-first becomes cheap instead of heroic. PouchDB + CouchDB replication matches the desired posture directly.
- Document-per-entity is the most conflict-resistant default under offline writes.
- DB-per-tenant provides a legible, strong isolation boundary aligned with replication and access control.
- Partitioned databases let us make doc kind a first-class invariant using `_id` structure, with no secondary “type” field.
- A single local tenant replica per device + tenant origin enables multi-app composition while offline.

## Consequences

### Positive
- Shipped apps operate offline with a mature local-first replication model.
- Clean conflict boundaries (per-entity docs).
- One stable, canonical doc-kind vocabulary shared across apps.
- Tenant boundary is legible at the DB level.
- Multiple apps can share doc kinds offline on the same device because they share the local tenant replica.

### Negative
- `_id` structure is a forever-commitment and migrations require new IDs.
- CouchDB operational hygiene (compaction, revision growth) becomes appliance responsibility.
- A shared local tenant replica means shipped apps must treat the tenant-local DB as shared infrastructure,
  not as app-private storage.

### Mitigation
- Keep a stable doc-kind vocabulary from the beginning.
- Make doc-kind changes explicit migrations (never “casual renames”).
- Build operational hygiene into the appliance:
  - automatic compaction schedules
  - clear storage accounting (“what is taking storage?”)
- Keep blobs out of CouchDB by default.

## References
- ADR-0001: Purpose-build Offline‑First PWAs for All Shipped OurBox Apps
- ADR-0003: Standardize on Tenant as the OurBox OS Data Boundary Term
- ADR-0004: OurBox Document IDs
- `docs/policies/founding/VALUES.md`
- `docs/policies/founding/CONSTITUTION.md`
- `docs/architecture/OurBox-OS-Terms-and-Definitions.md`
