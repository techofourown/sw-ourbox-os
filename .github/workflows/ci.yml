name: CI

on:
  push:
  pull_request:

jobs:
  graphmd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Ensure package-lock.json exists
        run: test -f package-lock.json

      - name: Ensure @graphmd/dataset lockfile is latest in range
        run: |
          node <<'NODE'
          const { execSync } = require('node:child_process');
          const pkg = require('./package.json');
          const lock = require('./package-lock.json');

          const range = pkg.devDependencies?.['@graphmd/dataset'];
          if (!range) {
            throw new Error('Missing @graphmd/dataset in devDependencies.');
          }

          const lockedVersion = lock.packages?.['node_modules/@graphmd/dataset']?.version;
          if (!lockedVersion) {
            throw new Error('package-lock.json is missing @graphmd/dataset.');
          }

          const latestVersion = execSync(`npm view @graphmd/dataset@${range} version`, {
            encoding: 'utf8',
          }).trim();

          if (lockedVersion !== latestVersion) {
            throw new Error(
              `Locked @graphmd/dataset ${lockedVersion} is not latest in range ${range} (${latestVersion}).`
            );
          }
          NODE

      - name: Install dependencies
        run: npm ci

      - name: Validate dataset + build spec
        run: npm test

      - name: Upload SPEC.md artifact
        uses: actions/upload-artifact@v4
        with:
          name: ourbox-os-spec
          path: SPEC.md
