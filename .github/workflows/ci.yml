name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Ensure package-lock.json exists
        run: |
          if [ ! -f package-lock.json ]; then
            echo "package-lock.json is missing. Run npm install." >&2
            exit 1
          fi

      - name: Ensure @graphmd/dataset lockfile is latest in-range
        run: |
          node <<'NODE'
          const fs = require("fs");
          const { execSync } = require("child_process");

          const pkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
          const range = pkg.devDependencies?.["@graphmd/dataset"];
          if (!range) {
            console.error("Missing @graphmd/dataset devDependency.");
            process.exit(1);
          }

          const lock = JSON.parse(fs.readFileSync("package-lock.json", "utf8"));
          const locked =
            lock.packages?.["node_modules/@graphmd/dataset"]?.version ||
            lock.dependencies?.["@graphmd/dataset"]?.version;
          if (!locked) {
            console.error("@graphmd/dataset is not present in package-lock.json.");
            process.exit(1);
          }

          const versionsJson = execSync(
            "npm view @graphmd/dataset versions --json",
          ).toString();
          const versions = JSON.parse(versionsJson);

          const parse = (value) => value.split(".").map((part) => Number(part));
          const compare = (a, b) => {
            for (let i = 0; i < 3; i += 1) {
              const diff = (a[i] || 0) - (b[i] || 0);
              if (diff !== 0) return diff;
            }
            return 0;
          };

          const satisfiesRange = (version) => {
            if (range === "0.x" || range === "0.*") {
              return parse(version)[0] === 0;
            }
            if (range.endsWith(".x") || range.endsWith(".*")) {
              const prefix = range.replace(/\.x$|\.\*$/, "");
              return version.startsWith(`${prefix}.`);
            }
            return true;
          };

          const candidates = versions.filter(satisfiesRange);
          if (!candidates.length) {
            console.error(`No versions satisfy range ${range}.`);
            process.exit(1);
          }

          const latest = candidates
            .map((version) => ({ version, parts: parse(version) }))
            .sort((a, b) => compare(a.parts, b.parts))
            .at(-1).version;

          if (locked !== latest) {
            console.error(
              `@graphmd/dataset lockfile version ${locked} is stale. Latest in-range is ${latest}.`,
            );
            process.exit(1);
          }

          console.log(`@graphmd/dataset is locked to latest in-range (${latest}).`);
          NODE

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Upload SPEC.md artifact
        uses: actions/upload-artifact@v4
        with:
          name: ourbox-os-spec
          path: SPEC.md
